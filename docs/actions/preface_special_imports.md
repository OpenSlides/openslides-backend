
## Special uploads and imports
The use case of these imports are some client side CSV uploads with data preview and following import. To use the features and technical abilities of our backend service actions we detached the server parts.
The client will prepare the CSV data as a payload to execute the `*.json-upload` action. Finally all values in the payload are represented as strings to the backend action. For representing the internal types, see [here](#internal-types). The response of the upload will be the prepared data for the preview, which will be shown by the client. After viewing the data, the user can call the `*.import` action.

## General format of the result send to the client for preview

```js
enum ImportState {
    Error = "error",
    Warning = "warning",
    New = "new",
    Done = "done",
    Generated = "generated",
    None = "none",
    // could be expanded later
}

{
    success: boolean;
    message: string;
    results: {
        state: ImportState; // one of `error` (no import possible), `warning` or `done` 
        id: number;  // id of action_worker to import
        headers: {
            property: string; // field name/column title
            type: "boolean" | "number" | "integer" | "string" | "date";  // date must be in format yyyy-mm-dd
            is_object: boolean;  // optional, if not given defaults to `false`
            is_list: boolean; // optional, if not given defaults to `false`
            is_hidden: boolean; // optional, if not given defaults to `false`
        }[];
        rows: {
            state: ImportState;
            messages: string[];
            data: {
                // property name and type must match an entry in the given `headers`
                [property: string]: (null | boolean | number | string | date | object) []; // if is_list is set in corresponding header column, we need here also a list. "object" only with `is_object` set
            };
        }[];
        statistics: {
            name: string, // text like "Total Number of Items", "Created", "Updated", depending the action
            value: number
        }[];
    }[];
}
```

The is_hidden property is only important in so far as it designates columns that should not be shown in the client

## The special type `object`
This type will be used, if we need to give more information than just a value (or a list of values) for one column. It will include the value, but in `info` it gives one of the predefined ImportStates, which the client can use to format the cell output. Also the type of the value is given and optionally the `id` of a found or created database object like an user. The format:
```js
{
  value: boolean | number | integer | string | date;
  info: ImportState;
  id: number;  // optional 
}
```

## Example of one result element:
```js
{
    headers: [{
        property: "name",
        type: "string",
    }, {
        property: "admin",
        type: "string",
        is_object: true,
        is_list: true,
    }],
    rows: [{
        state: "new",
        messages: [],
        data: {
            name: "test",
            admin: [
                {
                    value: "fritz",
                    info: "done",
                    id: 234
                },
                {
                    value: "kalle",
                    info: "new",
                },
            ]
        }
    }],
    statistics: [
        {name: "itemCount", value: 8},
        {name: "bla foo", value: 3},
        {name: "blub", value: 5}
    ]
}  
```

## The `ImportState` tokens

For notifying the client about the result or state of the whole preview, row or column, we use some tokens with following meaning:

- `error`: There is an error at this item which could prevent the import. However, this depends on the individual case.
- `warning`: Problem found, but the user may import if he accepts the warning.
- `new`: The referenced object or relation of row/column will be created 
- `done`: The referenced object will be treated as updated, added, found or existent, depending the context.
- `generated`: The referenced field was generated by the backend, e.g. a `default_password` or `username`.
- `none`: Nothing special,  for example an empty `meeting_template` field in committee import

## Internal Types

The internal types will be created by the backend service from the CSV-strings

- **string[]** The string list is represented as a comma-separated list of strings: `"admin"` or `"admin", "Miller, Frank"`
- **string** is just a string
- **boolean** for `True` use one of "True", "true", "T", "t", "Yes", "yes", "Y", "y" or "1", for `False` one of "False", "false", "F", "f", "No", "no", "N", "n" or "0"
- **integer** Use something like "1234" without fraction
- **number** means a `,` (comma) or `.` (point) separated value like `3123,45` or `3123.45`, but not `3.123,45` or `3,123.45`
- **decimal** A decimal number with exactly 6 digits after the decimal seperator dot, e.g. `1.500000`
- **date** Use a string in Isoformat "YYYY-MM-DD", for example "2023-04-26"  

## Import_Preview to store the data to import in database
```js
{
    id: int,              // id of the import_preview instance
    name: string,         // required by model: filled with _import_name_
    state: string,        // required: state of the whole import, one of done, error, warning.
    created: timestamp,   // required
    result:    // as preview with following keys
        rows: [  //details and example see above
            {
                state: string,   // row state, one of done, new, error
                messages: [string],
                data: json,
            }
        ]
}
```

## Json-Result from import
```js
{
    success: boolean;  // Only False if status code  == 400 plus 
    message: string;
    results: {  // exist only if success  is True
        state: ImportState; // one of `error` (no import possible), `warning` or `done` 
        rows: {      
            state: ImportState;  // row-state: one of done, new or error
            messages: string[];
            data: {
                // property name and type must match an entry in the given `headers`
                [property: string]: (boolean | number | string | date | object) []; // if is_list is set in corresponding header column, we need here also a list. `object` only on error
            };
        }[];  // row-list: Empty list, if `import` in payload was `false` to delete the import_preview-record on database
    }[[]];  // nested lists for actions and data row per action
}

``
