name: Continuous Integration

on:
  pull_request:
    branches: [ master ]

env:
  PYTHON_VERSION: 3.8.5

jobs:
  build-production-image:
    name: Build and test production docker image
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2

    - name: Run docker production image
      working-directory: .github/startup_test
      run: docker-compose up -d

    - name: Wait for action service
      working-directory: .github/startup_test
      run: docker-compose exec -T backend ./wait.sh backend 9002

    - name: Fire a test request to actions component
      run: curl -I localhost:9002/health

    - name: Fire a test request to presenter component
      run: curl -I localhost:9003/health

  build-and-test-dev-image:
    name: Build and test development docker image with Docker Compose
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Run tests
      run: dev/run-tests.sh
  
  check-coding-style-black:
    name: Check coding style with black
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install requirements
      run: pip install --requirement dev/requirements_development.txt

    - name: Check black
      run: black --check --diff openslides_backend/ tests/ cli/

  check-coding-style-isort:
    name: Check coding style with isort
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install requirements
      run: pip install --requirement dev/requirements_development.txt

    - name: Check isort
      run: isort --check-only --diff openslides_backend/ tests/ cli/

  check-coding-style-flake8:
    name: Check coding style with flake8
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install requirements
      run: pip install --requirement dev/requirements_development.txt

    - name: Check flake8
      run: flake8 openslides_backend/ tests/ cli/

  check-coding-style-mypy:
    name: Check coding style with mypy
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install requirements
      run: pip install --requirement dev/requirements_development.txt

    - name: Check mypy
      run: mypy openslides_backend/ tests/ cli/

  check-models-all:
    name: Check from models.yml up to permissions and jsons
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      id: python
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install requirements
      id: requirements
      run: pip install --requirement dev/requirements_development.txt

    - name: Validate models.yml
      id: models_yml
      if: ${{ steps.python.outcome == 'success' && steps.requirements.outcome == 'success' }}
      run: PYTHONPATH=. python cli/modelsvalidator/validate.py

    - name: Check for up tp date models.py
      id: models_py
      if: ${{ steps.models_yml.outcome == 'success' }}
      run: PYTHONPATH=. python cli/generate_models.py check

    - name: Check initial-data.json
      if: ${{ steps.models_py.outcome == 'success' }}
      run: PYTHONPATH=. python cli/check_json.py docs/initial-data.json

    - name: Check example-data.json
      if: ${{ steps.models_py.outcome == 'success' }}
      run: PYTHONPATH=. python cli/check_json.py docs/example-data.json

    - name: Check for up to date permissions.py
      if: ${{ steps.python.outcome == 'success' && steps.requirements.outcome == 'success' }}
      run: PYTHONPATH=. python3 cli/generate_permissions.py check
